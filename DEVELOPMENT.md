# Locustron Development Guide

## Development Environment Setup

### Prerequisites

For cross-platform development and testing, you'll need to set up a Lua development environment:

1. **Install Lua 5.4+** (required for vanilla Lua development)
2. **Install LuaRocks** (Lua package manager)
3. **Install Busted** (BDD testing framework)
4. **Install Yotta** (Picotron package manager)

```bash
# Install LuaRocks (varies by system)
# Ubuntu/Debian:
sudo apt-get install luarocks

# macOS (with Homebrew):
brew install luarocks

# Install Busted for BDD testing
luarocks install busted

# Verify installation
busted --version
lua -v
```

### Picotron Package Management

For Picotron development, you'll also need yotta (Picotron's package manager):

```bash
# Install yotta (follow official Picotron documentation)
# After installation, you can install locustron as a package for testing:
yotta add #locustron

# This will install locustron to lib/locustron/ for local testing
# Note: lib/ folder is excluded from git as it contains installed packages
```

### Running Tests

```bash
# Run cross-platform BDD tests
busted tests/vanilla/

# Run specific test file
busted tests/vanilla/setup_spec.lua

# Run with verbose output
busted --verbose tests/vanilla/
```

## Project Structure

Locustron uses a clear separation between platform-specific and cross-platform code:

```
src/
├── picotron/              # Picotron-specific implementation
│   ├── locustron.lua      # Main userdata-based implementation
│   ├── require.lua        # Picotron module system
│   ├── locustron_demo.lua # Interactive demo
│   ├── benchmarks/        # Picotron performance tests
│   └── tests/             # Unitron test suite
└── vanilla/               # Cross-platform implementation
    ├── strategy_interface.lua    # Abstract strategy pattern
    ├── fixed_grid_strategy.lua   # Vanilla Lua Fixed Grid
    ├── doubly_linked_list.lua    # Memory-efficient cell management
    ├── benchmark_suite.lua       # Performance benchmarking
    └── [additional strategies]   # Future implementations
lib/                       # Yotta package installations (excluded from git)
exports/                   # Build artifacts (excluded from git) 
tests/
├── picotron/              # Picotron unitron tests
└── vanilla/               # Cross-platform BDD tests
benchmarks/
├── picotron/              # Picotron performance tests
└── vanilla/               # Cross-platform benchmarks
```

## Development Workflows

### Picotron Development

1. **Main Implementation**: Edit `src/picotron/locustron.lua`
2. **Testing**: Run `src/picotron/tests/test_locustron_unit.lua` in unitron
3. **Demo**: Run `include("src/picotron/locustron_demo.lua")` in Picotron console
4. **Benchmarks**: Run `src/picotron/benchmarks/run_all_benchmarks.lua`

### Cross-Platform Development

1. **Strategy Development**: Work in `src/vanilla/`
2. **Testing**: Run `busted tests/vanilla/` from project root
3. **Benchmarking**: Use `lua benchmark.lua` CLI tools

### Package Export

The `export_package.lua` script manages the export workflow:
- **Directory setup**: Automatically creates `lib/locustron/` and `exports/` directories if they don't exist
- **Build artifacts**: Both `lib/` and `exports/` folders contain generated files and are excluded from git
- **Dual sync**: Copies `src/picotron/` files to both `lib/locustron/` (for local yotta simulation) and `exports/` (for BBS distribution)  
- **Validation**: Verifies package integrity and file presence
- **BBS preparation**: Prepares cartridge for publication with proper metadata

**Publishing Methods:**
1. **GitHub Repository**: Contains the complete source code in `src/` with development files
2. **Lexaloffle BBS**: Contains the exported `locustron.p64.png` cartridge as a yotta package (generated from `exports/` folder)

**Package Management:**
- **lib/**: Managed by yotta package manager (install packages here with `yotta add`)
- **exports/**: Generated by export script for BBS publication

## Testing Strategy

- **Picotron Tests** (`src/picotron/tests/`): Validate userdata implementation
- **Vanilla Tests** (`tests/vanilla/`): Cross-platform BDD tests with Busted
- **Integration**: Both test suites validate identical API behavior

## Contributing

1. Follow the platform separation: Picotron-specific code in `src/picotron/`, cross-platform in `src/vanilla/`
2. Maintain API compatibility between implementations
3. Add tests for both platforms when adding features
4. Update documentation for structural changes

## Git Commit Message Enforcement

This repository uses [Conventional Commits](https://www.conventionalcommits.org/) for consistent commit messages. To enable automatic validation of your commit messages:

```bash
# After cloning the repository, enable the commit-msg hook:
chmod +x .git/hooks/commit-msg
```

This will enforce the following commit message format:
```
<type>[optional scope]: <description>
```

**Valid commit types:**
- `feat` - A new feature
- `fix` - A bug fix  
- `docs` - Documentation changes
- `test` - Adding or updating tests
- `refactor` - Code refactoring
- `perf` - Performance improvements
- `chore` - Build process or auxiliary tool changes

**Examples:**
```bash
git commit -m "feat(locustron): add spatial hash optimization"
git commit -m "fix(tests): handle unknown object error in delete tests"  
git commit -m "docs: update README with setup instructions"
```

If your commit message doesn't follow this format, the commit will be rejected with helpful guidance.